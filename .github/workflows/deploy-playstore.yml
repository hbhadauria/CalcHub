name: Deploy to Play Store

# Trigger via manual dispatch or reusable workflow call
on:
  workflow_dispatch:
    inputs:
      track:
        description: 'The track to deploy to'
        required: true
        default: 'internal'
        type: choice
        options:
          - production
          - beta
          - alpha
          - internal
  workflow_call:
    inputs:
      track:
        description: 'The track to deploy to'
        required: true
        type: string


jobs:
  deploy:
    name: Deploy to Play Store
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download build artifacts generated by previous jobs
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: app/build/outputs/

      
      # Decode the Service Account JSON for Google Play API access
      - name: Decode Service Account Key
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
        run: echo "$SERVICE_ACCOUNT_JSON" | base64 -d > service_account.json


      # Upload the AAB to the Play Console
      - name: Deploy to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: service_account.json
          packageName: com.hsb.calchub
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: ${{ inputs.track }}
          status: completed
          whatsNewDirectory: distribution/whatsnew
          mappingFile: app/build/outputs/mapping/release/mapping.txt

