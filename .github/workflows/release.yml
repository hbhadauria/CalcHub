name: Create New Release

on:
  workflow_dispatch:
    inputs:
      run_security_scan:
        description: 'Run CodeQL security scan? (Recommended for release)'
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      run_unit_tests:
        description: 'Run unit tests? (Prevents bad builds)'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      track:
        description: 'The track to deploy to (internal, alpha, beta, production)'
        required: true
        default: 'internal'
        type: choice
        options:
          - production
          - beta
          - alpha
          - internal
      bump_version_code:
        description: 'Auto-increment Build Number? (Select "no" to keep current)'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      version_name:
        description: 'New Version Name (e.g. 1.2.0). Leave empty to keep current.'
        required: false
        type: string

jobs:
  version-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version_code: ${{ steps.bump.outputs.version_code }}
      new_version_name: ${{ steps.bump.outputs.version_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump Version
        id: bump
        run: |
          # Read properties
          FILE="version.properties"
          if [ -f "$FILE" ]; then
            while IFS='=' read -r key value; do
              export "$key=$value"
            done < "$FILE"
          else
            echo "version.properties not found!"
            exit 1
          fi


          # Increment Code
          if [ "${{ github.event.inputs.bump_version_code }}" == "yes" ]; then
            NEW_CODE=$((VERSION_CODE + 1))
          else
            NEW_CODE=$VERSION_CODE
          fi
          
          # Determine Name
          if [ -n "${{ github.event.inputs.version_name }}" ]; then
            NEW_NAME="${{ github.event.inputs.version_name }}"
          else
            NEW_NAME="$VERSION_NAME"
          fi

          # Write back
          echo "VERSION_CODE=$NEW_CODE" > "$FILE"
          echo "VERSION_NAME=$NEW_NAME" >> "$FILE"
          
          echo "version_code=$NEW_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_NAME" >> $GITHUB_OUTPUT
          
          # Display
          echo "Bumping version: $VERSION_NAME ($VERSION_CODE) -> $NEW_NAME ($NEW_CODE)"

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: bump version to ${{ steps.bump.outputs.version_name }} ($((VERSION_CODE + 1))) [skip ci]"
          file_pattern: version.properties

  security-scan:
    needs: version-bump
    if: ${{ github.event.inputs.run_security_scan == 'yes' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    uses: ./.github/workflows/codeql-analysis.yml

  test:
    if: ${{ github.event.inputs.run_unit_tests == 'yes' }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    uses: ./.github/workflows/unit-test.yml

  build:
    needs: [test, version-bump]
    # Run build if version-bump succeeded AND (tests succeeded OR tests were skipped)
    if: ${{ always() && needs.version-bump.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped') }}
    uses: ./.github/workflows/build-bundle.yml
    secrets: inherit

  deploy:
    needs: build
    uses: ./.github/workflows/deploy-playstore.yml
    with:
      track: ${{ github.event.inputs.track }}
    secrets: inherit

  create-github-release:
    needs: [version-bump, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/

      - name: Extract Release Notes from CHANGELOG
        id: extract_notes
        run: |
          VERSION="${{ needs.version-bump.outputs.new_version_name }}"
          
          # Extract content between version header and next version or separator
          # Stop at next ## [ or --- line using flag-based awk
          NOTES=$(awk "/## \\[$VERSION\\]/{flag=1; next} /^## \\[/{flag=0} /^---$/{flag=0} flag" CHANGELOG.md)
          
          # If no notes found, create basic release notes
          if [ -z "$NOTES" ]; then
            NOTES="Release version $VERSION (Build ${{ needs.version-bump.outputs.new_version_code }})"
          fi
          
          # Save to file for multiline content
          echo "$NOTES" > release_notes.md
          
          echo "Release notes extracted for version $VERSION"
          cat release_notes.md

      - name: Create Git Tag
        run: |
          VERSION="${{ needs.version-bump.outputs.new_version_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION (Build ${{ needs.version-bump.outputs.new_version_code }})"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-bump.outputs.new_version_name }}
          name: CalcHub v${{ needs.version-bump.outputs.new_version_name }} (Build ${{ needs.version-bump.outputs.new_version_code }})
          body_path: release_notes.md
          files: |
            artifacts/bundle/release/*.aab
            artifacts/mapping/release/mapping.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
